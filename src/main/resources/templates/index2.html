<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>House Finder</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #map { height: 500px; margin-top: 10px; }
        body { font-family: Arial, sans-serif; padding: 20px; }
        input { padding: 8px; margin-right: 10px; }
        button { padding: 8px; }
        p#error { color:red; }
    </style>
</head>
<body>
<h2>üè† House Finder (Tilottama Ward-9)</h2>

<form id="searchForm" th:action="@{/search}" method="post">
    <input type="text" name="name" placeholder="Enter house name..." required>
    <button type="submit">Search</button>
</form>

<p id="error" th:text="${error}"></p>

<div id="map"></div>

<script>
    let defaultLat = [[${lat}]];
    let defaultLng = [[${lng}]];
    let houseName = '[[${houseName}]]';

    let map, userMarker, destinationMarker, directionsService, directionsRenderer;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: defaultLat, lng: defaultLng },
            zoom: 16
        });

        // Default house marker
        destinationMarker = new google.maps.Marker({
            position: { lat: defaultLat, lng: defaultLng },
            map: map,
            title: houseName
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: false
        });

        updateUserLocation();
    }

    function updateUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                if (!userMarker) {
                    userMarker = new google.maps.Marker({
                        position: { lat: lat, lng: lng },
                        map: map,
                        title: "You are here"
                    });
                } else {
                    userMarker.setPosition({ lat: lat, lng: lng });
                }

                map.setCenter({ lat: lat, lng: lng });

                // If destination exists, show route (driving by default)
                if(destinationMarker) {
                    calculateRoute(lat, lng, destinationMarker.getPosition().lat(), destinationMarker.getPosition().lng(), "DRIVING");
                }

            }, function() {
                console.log("Cannot get user location");
            });
        }
    }

    setInterval(updateUserLocation, 5000); // update every 5 sec

    function calculateRoute(userLat, userLng, destLat, destLng, mode) {
        directionsService.route({
            origin: { lat: userLat, lng: userLng },
            destination: { lat: destLat, lng: destLng },
            travelMode: google.maps.TravelMode[mode] // DRIVING, WALKING, BICYCLING
        }, function(response, status) {
            if (status === 'OK') {
                directionsRenderer.setDirections(response);
                const route = response.routes[0].legs[0];
                console.log(`Distance: ${route.distance.text}, Duration: ${route.duration.text}`);
            } else {
                console.error('Directions request failed due to ' + status);
            }
        });
    }

    window.initMap = initMap;
</script>

<script async
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
</script>
</body>
</html>
